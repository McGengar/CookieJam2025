[gd_scene load_steps=28 format=3 uid="uid://was10nolxbaj"]

[ext_resource type="Texture2D" uid="uid://c4yrr3542a13n" path="res://Sprites/ani_1_ver.png" id="1_dewec"]
[ext_resource type="Script" uid="uid://bdid18rcqjcb7" path="res://Scripts/slashpivot.gd" id="1_gntrk"]
[ext_resource type="Texture2D" uid="uid://cmy2ovhqsi5oo" path="res://Sprites/dupkaa.png" id="1_megsn"]
[ext_resource type="Texture2D" uid="uid://b42vjrbdb4fbi" path="res://Sprites/slash_sprite_sheet.png" id="1_rpqav"]
[ext_resource type="Texture2D" uid="uid://deks0o0mr64d4" path="res://Sprites/ani_1_ver-export.png" id="1_yoq75"]
[ext_resource type="PackedScene" uid="uid://r7jl6epbow87" path="res://Scenes/phone_ui.tscn" id="2_5ixxa"]
[ext_resource type="Texture2D" uid="uid://ieyvrrouvh36" path="res://Sprites/scythe.png" id="2_kyqiw"]
[ext_resource type="PackedScene" uid="uid://cqfmvrr3vyl0g" path="res://Scenes/luck_bar.tscn" id="3_nn08x"]
[ext_resource type="Texture2D" uid="uid://dxxl7pfi1ti2u" path="res://Sprites/arrow.png" id="7_52ee3"]
[ext_resource type="Script" path="res://Scripts/health_bar.gd" id="8_bhhdu"]

[sub_resource type="GDScript" id="GDScript_qbkls"]
resource_name = "player"
script/source = "extends CharacterBody2D
@onready var timer: Timer = $Timer
@onready var platformchecker: RayCast2D = $platformchecker
@onready var nothingchecker: RayCast2D = $nothingchecker
@onready var sprite_2d: AnimatedSprite2D = $Sprite2D
@onready var slashpivot: Node2D = $slashpivot
@onready var animated_sprite_2d: AnimatedSprite2D = $slashpivot/AnimatedSprite2D



var SPEED = Player_globals.speed
var JUMP_VELOCITY = Player_globals.jump
var attack_speed = Player_globals.attack_speed
var damage = Player_globals.damage
var max_hp = Player_globals.max_hp
var max_jumps = Player_globals.max_jumps
var hp = max_hp


var jumps_avail = max_jumps

var ledge_progress = 0
var last_dir
var is_wall_jumping = false
var is_climbing = false
var can_atk = true
var last_wall = 0
var hit_enemies: Array = []
var dead = false

func _ready() -> void:
	SPEED = Player_globals.speed
	JUMP_VELOCITY = Player_globals.jump
	attack_speed = Player_globals.attack_speed
	damage = Player_globals.damage
	max_hp = Player_globals.max_hp
	max_jumps = Player_globals.max_jumps
	hp = max_hp
func _physics_process(delta):
	if not is_on_floor() and not is_on_wall() and is_climbing == false:
			velocity += get_gravity() * delta
	if not dead:
		if Input.is_action_just_pressed(\"debug_1\"):
			Player_globals.debug_gen_card()
			refresh_stats()
		
		$Sprite2D.speed_scale = SPEED/400
		var direction = Input.get_axis(\"move_left\", \"move_right\")
		if direction!=0 and not is_on_wall():
			$Sprite2D.play(\"walk\")
		elif direction ==0:
			$Sprite2D.play(\"stand\")
		if is_on_floor():
			jump_refresh()
			last_wall = 0
		if is_on_wall():
			sprite_2d.play(\"slide\")
			if velocity.y < 0:
				pass
				velocity.y *= 0.9
			velocity += get_gravity() * delta /4
		if is_on_wall() and is_climbing == false:
			jump_refresh()
			if Input.is_action_just_pressed(\"jump\"):
				if Input.is_action_pressed(\"move_right\"):
					last_wall = 1
					if jumps_avail > 0:
						jump_timer()
						velocity.y = JUMP_VELOCITY
						velocity.x += -direction * SPEED
						jumps_avail -= 1
				elif Input.is_action_pressed(\"move_left\"):
					last_wall = -1
					if jumps_avail > 0:
						jump_timer()
						velocity.y = JUMP_VELOCITY
						velocity.x += -direction * SPEED
						jumps_avail -= 1
		if Input.is_action_just_pressed(\"interact\"):
			attack()
		# Handle jump.
		if Input.is_action_just_pressed(\"jump\") and jumps_avail > 0 and is_on_floor():
			jumps_avail -= 1
			velocity.y = JUMP_VELOCITY
		if platformchecker.is_colliding() and not nothingchecker.is_colliding() and is_on_wall():
			is_climbing = true
		if is_climbing == true:
				move_to_path(delta,last_dir)
		else:
			ledge_progress = 0
		if direction == -1:
			last_dir = direction
			sprite_2d.flip_h = true
			platformchecker.rotation = deg_to_rad(180)
			nothingchecker.rotation = deg_to_rad(180)
		elif direction == 1:
			last_dir = direction
			sprite_2d.flip_h = false
			platformchecker.rotation = deg_to_rad(0)
			nothingchecker.rotation = deg_to_rad(0)
		if direction and is_wall_jumping == false and is_climbing == false:
			velocity.x = direction * SPEED
		elif is_wall_jumping == false and is_climbing == false:
				velocity.x = move_toward(velocity.x, 0, SPEED)

		move_and_slide()

func refresh_stats():
	SPEED = Player_globals.speed
	JUMP_VELOCITY = Player_globals.jump
	attack_speed = Player_globals.attack_speed
	damage = Player_globals.damage
	max_hp = Player_globals.max_hp
	max_jumps = Player_globals.max_jumps

func attack():
	if can_atk:
			hit_enemies.clear()
			$slashpivot/AnimatedSprite2D/Area2D.monitoring=true
			can_atk = false
			animated_sprite_2d.visible=true
			await get_tree().create_timer(0.75).timeout
			$slashpivot/AnimatedSprite2D/Area2D.monitoring=false
			animated_sprite_2d.visible=false
			can_atk = true
func jump_refresh():
	jumps_avail = max_jumps

func jump_timer():
	timer.start()
	is_wall_jumping = true
func move_to_path(how_much,dir):
	if is_climbing and not is_wall_jumping:
		var save_dir = dir
		ledge_progress += how_much*2
		velocity.y = -180 * ledge_progress
		await get_tree().create_timer(0.35).timeout
		if ledge_progress + how_much > 1:
			velocity.x = save_dir * 1000 * ledge_progress
			is_climbing = false
		
func _on_timer_timeout() -> void:
	is_wall_jumping = false

func take_dmg(amount):
	hp -= amount
	if hp <= 0:
		die()
func die():
	dead = true
	rotation = deg_to_rad(90)
	sprite_2d.play(\"dead\")
func _on_area_2d_body_entered(body: Node2D) -> void:
	if body.is_in_group(\"enemies\") and not body in hit_enemies:
		body.take_dmg(damage)
		hit_enemies.append(body)
	elif body.is_in_group(\"slotsmachine\"):
		body.take_dmg(5)

@onready var arrow_pivot: Marker2D = $ArrowPivot

var rotation_smoothing_speed: float = 15.0

func _process(delta: float) -> void:
	update_arrow_direction(delta)

func update_arrow_direction(delta: float) -> void:
	var nearest_enemy = find_nearest_enemy()

	if nearest_enemy and is_instance_valid(nearest_enemy):
		arrow_pivot.show()
		
		var direction = nearest_enemy.global_position - global_position
		
		var target_angle = direction.angle()
		
		arrow_pivot.rotation = lerp_angle(arrow_pivot.rotation, target_angle, rotation_smoothing_speed * delta)
		
	else:
		arrow_pivot.hide()

func find_nearest_enemy() -> Node2D:
	var all_enemies = get_tree().get_nodes_in_group(\"enemies\")
	
	if all_enemies.is_empty():
		return null

	var nearest: Node2D = null
	var shortest_distance_squared = INF 
	
	for enemy in all_enemies:
		if is_instance_valid(enemy):
			var distance_sq = global_position.distance_squared_to(enemy.global_position)
			
			if distance_sq < shortest_distance_squared:
				shortest_distance_squared = distance_sq
				nearest = enemy
				
	return nearest
"

[sub_resource type="AtlasTexture" id="AtlasTexture_miouo"]
atlas = ExtResource("1_yoq75")
region = Rect2(0, 0, 80, 96)

[sub_resource type="AtlasTexture" id="AtlasTexture_glx4g"]
atlas = ExtResource("1_dewec")
region = Rect2(0, 0, 64, 96)

[sub_resource type="AtlasTexture" id="AtlasTexture_52ee3"]
atlas = ExtResource("1_dewec")
region = Rect2(0, 0, 64, 96)

[sub_resource type="AtlasTexture" id="AtlasTexture_bhhdu"]
atlas = ExtResource("1_dewec")
region = Rect2(64, 0, 64, 96)

[sub_resource type="AtlasTexture" id="AtlasTexture_megsn"]
atlas = ExtResource("1_dewec")
region = Rect2(128, 0, 64, 96)

[sub_resource type="AtlasTexture" id="AtlasTexture_yoq75"]
atlas = ExtResource("1_dewec")
region = Rect2(192, 0, 64, 96)

[sub_resource type="AtlasTexture" id="AtlasTexture_ksbbd"]
atlas = ExtResource("1_dewec")
region = Rect2(256, 0, 64, 96)

[sub_resource type="SpriteFrames" id="SpriteFrames_glx4g"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_miouo")
}],
"loop": true,
"name": &"dead",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_megsn")
}],
"loop": true,
"name": &"slide",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_glx4g")
}],
"loop": true,
"name": &"stand",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_52ee3")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_bhhdu")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_megsn")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_yoq75")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ksbbd")
}],
"loop": true,
"name": &"walk",
"speed": 12.0
}]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_kyqiw"]
size = Vector2(54, 80)

[sub_resource type="AtlasTexture" id="AtlasTexture_nn08x"]
atlas = ExtResource("1_rpqav")
region = Rect2(256, 0, 64, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_kyqiw"]
atlas = ExtResource("1_rpqav")
region = Rect2(0, 0, 64, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_gntrk"]
atlas = ExtResource("1_rpqav")
region = Rect2(64, 0, 64, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_dewec"]
atlas = ExtResource("1_rpqav")
region = Rect2(128, 0, 64, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_5ixxa"]
atlas = ExtResource("1_rpqav")
region = Rect2(192, 0, 64, 64)

[sub_resource type="SpriteFrames" id="SpriteFrames_52ee3"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_nn08x")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_kyqiw")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_gntrk")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_dewec")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_5ixxa")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_nn08x")
}],
"loop": false,
"name": &"default",
"speed": 20.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("2_kyqiw")
}],
"loop": true,
"name": &"new_animation",
"speed": 5.0
}]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_bhhdu"]
radius = 37.83251
height = 75.66502

[node name="Player" type="CharacterBody2D" groups=["player"]]
top_level = true
collision_layer = 2
script = SubResource("GDScript_qbkls")

[node name="Sprite2D" type="AnimatedSprite2D" parent="."]
position = Vector2(0, -14)
sprite_frames = SubResource("SpriteFrames_glx4g")
animation = &"dead"
autoplay = "stand"

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(0, -13)
shape = SubResource("RectangleShape2D_kyqiw")

[node name="Camera2D" type="Camera2D" parent="."]
zoom = Vector2(1.5, 1.5)

[node name="PhoneUI" parent="Camera2D" node_paths=PackedStringArray("luck_bar") instance=ExtResource("2_5ixxa")]
position = Vector2(-343, -25)
cooldown_time = 1.0
luck_bar = NodePath("LuckBar")

[node name="LuckBar" parent="Camera2D/PhoneUI" instance=ExtResource("3_nn08x")]
offset_left = -23.0
offset_top = -183.0
offset_right = 243.0
offset_bottom = -156.0
decay_speed = 10.0

[node name="Timer" type="Timer" parent="."]
wait_time = 0.2

[node name="platformchecker" type="RayCast2D" parent="."]
position = Vector2(0, 9)
target_position = Vector2(36, 0)

[node name="nothingchecker" type="RayCast2D" parent="."]
position = Vector2(1, -25)
target_position = Vector2(36, 0)

[node name="slashpivot" type="RigidBody2D" parent="."]
freeze = true
script = ExtResource("1_gntrk")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="slashpivot"]
z_index = 1
position = Vector2(0.9999962, -33)
scale = Vector2(3.171875, 3.171875)
sprite_frames = SubResource("SpriteFrames_52ee3")

[node name="Area2D" type="Area2D" parent="slashpivot/AnimatedSprite2D"]
position = Vector2(15.000002, 42)
collision_layer = 0
collision_mask = 4
monitoring = false

[node name="CollisionShape2D" type="CollisionShape2D" parent="slashpivot/AnimatedSprite2D/Area2D"]
position = Vector2(-14.68473, -36.325123)
shape = SubResource("CapsuleShape2D_bhhdu")

[node name="atkcd" type="Timer" parent="slashpivot"]
wait_time = 0.75

[node name="ArrowPivot" type="Marker2D" parent="."]

[node name="ArrowSprite" type="Sprite2D" parent="ArrowPivot"]
position = Vector2(130, 0)
rotation = 1.5707964
texture = ExtResource("7_52ee3")

[node name="ProgressBar" type="ProgressBar" parent="."]
offset_left = -366.0
offset_top = -177.0
offset_right = -183.0
offset_bottom = -122.0
show_percentage = false
script = ExtResource("8_bhhdu")

[connection signal="timeout" from="Timer" to="." method="_on_timer_timeout"]
[connection signal="area_entered" from="slashpivot/AnimatedSprite2D/Area2D" to="." method="_on_area_2d_area_entered"]
[connection signal="body_entered" from="slashpivot/AnimatedSprite2D/Area2D" to="." method="_on_area_2d_body_entered"]
[connection signal="timeout" from="slashpivot/atkcd" to="slashpivot" method="_on_atkcd_timeout"]
